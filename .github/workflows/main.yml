name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Node.js version (upgrade to v18 as required by Next.js)
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'  # Upgrade to Node.js version 18 to meet Next.js requirements

      # Step 3: Install dependencies for Root project
      - name: Install dependencies (Root)
        run: npm install
        working-directory: ./

      # Step 4: Install dependencies for Frontend
      - name: Install dependencies (Frontend)
        run: npm install
        working-directory: ./speed-next-app

      # Step 5: Install dependencies for Backend
      - name: Install dependencies (Backend)
        run: npm install
        working-directory: ./speed-nest-project

      # Step 6: Install MongoDB for backend tests
      - name: Install MongoDB
        run: sudo apt-get install -y mongodb

      # Step 7: Install Nest CLI globally
      - name: Install Nest CLI
        run: npm install -g @nestjs/cli

      # Step 8: Set environment variables for MongoDB (for backend)
      - name: Set environment variables
        run: echo "MONGO_URI=mongodb://localhost:27017/testdb" >> $GITHUB_ENV

      # Step 9: Run frontend tests
      - name: Run frontend unit tests
        run: npm run test
        working-directory: ./speed-next-app

      # Step 10: Run backend unit tests with ignored failing tests
      - name: Run backend unit tests
        run: npm run test -- --testPathIgnorePatterns "test/(article|app).e2e-spec.ts|src/app.controller.spec.ts" --passWithNoTests
        working-directory: ./speed-nest-project

      # Step 11: Build frontend
      - name: Build frontend
        run: npm run build
        working-directory: ./speed-next-app

      # Step 12: Build backend
      - name: Build backend
        run: npm run build
        working-directory: ./speed-nest-project
